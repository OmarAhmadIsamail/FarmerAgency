<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>Analytics - FarmAgency</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect">
  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Raleway:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">

  <!-- Vendor CSS Files -->
  <link href="../assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="../assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Owner CSS -->
  <link href="../assets/css/owner.css" rel="stylesheet">
  
  <style>
    .chart-container {
      position: relative;
      height: 300px;
      margin-bottom: 20px;
    }
    
    .analytics-card {
      transition: transform 0.3s ease;
    }
    
    .analytics-card:hover {
      transform: translateY(-5px);
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .stat-item {
      background: white;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      text-align: center;
    }
    
    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #2c5530;
    }
    
    .stat-label {
      font-size: 14px;
      color: #666;
    }
    
    .trend-up {
      color: #28a745;
    }
    
    .trend-down {
      color: #dc3545;
    }
    
    .date-filter {
      background: white;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }
    
    .chart-legend {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      margin: 0 10px;
    }
    
    .legend-color {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 5px;
    }
    
    .comparison-card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    .comparison-value {
      font-size: 18px;
      font-weight: bold;
    }
    
    .comparison-positive {
      color: #28a745;
    }
    
    .comparison-negative {
      color: #dc3545;
    }
    
    .product-performance-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .product-performance-table th {
      background-color: #f8f9fa;
      text-align: left;
      padding: 10px;
      border-bottom: 1px solid #dee2e6;
    }
    
    .product-performance-table td {
      padding: 10px;
      border-bottom: 1px solid #dee2e6;
    }
    
    .performance-badge {
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .performance-high {
      background-color: #d4edda;
      color: #155724;
    }
    
    .performance-medium {
      background-color: #fff3cd;
      color: #856404;
    }
    
    .performance-low {
      background-color: #f8d7da;
      color: #721c24;
    }
  </style>
</head>

<body class="owner-body">
  
  <!-- Sidebar -->
  <nav class="owner-sidebar">
    <div class="sidebar-brand">
      <h4 class="mb-0" id="farm-name">Farm Name</h4>
      <small class="text-muted">Owner Dashboard</small>
    </div>
    
    <ul class="sidebar-nav">
      <li class="nav-item">
        <a class="nav-link" href="index.html">
          <i class="bi bi-speedometer2"></i> Dashboard
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="products.html">
          <i class="bi bi-box-seam"></i> My Products
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="orders.html">
          <i class="bi bi-cart-check"></i> Farm Orders
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link active" href="analytics.html">
          <i class="bi bi-graph-up"></i> Analytics
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="profile.html">
          <i class="bi bi-gear"></i> Farm Profile
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="../index.html">
          <i class="bi bi-house"></i> Back to Site
        </a>
      </li>
    </ul>
  </nav>

  <!-- Main Content -->
  <main class="owner-main">
    <div class="owner-header">
      <div class="d-flex justify-content-between align-items-center">
        <h1 class="h3 mb-0">Farm Analytics</h1>
        <div class="owner-user">
          <span class="me-2">Welcome, <span id="owner-name">Owner</span></span>
          <span class="farm-badge">
            <i class="bi bi-tree-fill"></i>
            <span id="display-farm-name">Farm Name</span>
          </span>
        </div>
      </div>
    </div>

    <!-- Date Range Filter -->
    <div class="date-filter">
      <div class="row align-items-center">
        <div class="col-md-6">
          <h5 class="mb-0">Performance Overview</h5>
          <p class="text-muted mb-0">Track your farm's performance metrics</p>
        </div>
        <div class="col-md-6 text-end">
          <div class="btn-group">
            <button type="button" class="btn btn-outline-primary active" data-period="week">This Week</button>
            <button type="button" class="btn btn-outline-primary" data-period="month">This Month</button>
            <button type="button" class="btn btn-outline-primary" data-period="quarter">This Quarter</button>
            <button type="button" class="btn btn-outline-primary" data-period="year">This Year</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Key Metrics -->
    <div class="stats-grid">
      <div class="stat-item">
        <div class="stat-value" id="total-revenue">$0</div>
        <div class="stat-label">Total Revenue</div>
        <div class="trend-up" id="revenue-trend">+0%</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="total-orders">0</div>
        <div class="stat-label">Total Orders</div>
        <div class="trend-up" id="orders-trend">+0%</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="avg-order-value">$0</div>
        <div class="stat-label">Avg Order Value</div>
        <div class="trend-up" id="aov-trend">+0%</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="customer-count">0</div>
        <div class="stat-label">Customers</div>
        <div class="trend-up" id="customer-trend">+0%</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="net-earnings">$0</div>
        <div class="stat-label">Net Earnings</div>
        <div class="trend-up" id="earnings-trend">+0%</div>
      </div>
    </div>

    <!-- Charts Row 1 -->
    <div class="row mt-4">
      <div class="col-lg-8">
        <div class="owner-card analytics-card">
          <div class="card-body">
            <h5 class="card-title">Revenue Trend</h5>
            <div class="chart-container">
              <canvas id="revenueChart"></canvas>
            </div>
            <div class="chart-legend">
              <div class="legend-item">
                <div class="legend-color" style="background-color: #2c5530;"></div>
                <span>Revenue</span>
              </div>
              <div class="legend-item">
                <div class="legend-color" style="background-color: #6c757d;"></div>
                <span>Previous Period</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-lg-4">
        <div class="owner-card analytics-card">
          <div class="card-body">
            <h5 class="card-title">Sales by Category</h5>
            <div class="chart-container">
              <canvas id="categoryChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts Row 2 -->
    <div class="row mt-4">
      <div class="col-lg-6">
        <div class="owner-card analytics-card">
          <div class="card-body">
            <h5 class="card-title">Order Status Distribution</h5>
            <div class="chart-container">
              <canvas id="orderStatusChart"></canvas>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-lg-6">
        <div class="owner-card analytics-card">
          <div class="card-body">
            <h5 class="card-title">Monthly Performance</h5>
            <div class="chart-container">
              <canvas id="monthlyChart"></canvas>
            </div>
            <div class="chart-legend">
              <div class="legend-item">
                <div class="legend-color" style="background-color: #2c5530;"></div>
                <span>Revenue</span>
              </div>
              <div class="legend-item">
                <div class="legend-color" style="background-color: #fd7e14;"></div>
                <span>Orders</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Product Performance -->
    <div class="row mt-4">
      <div class="col-12">
        <div class="owner-card analytics-card">
          <div class="card-body">
            <h5 class="card-title">Product Performance</h5>
            <div class="table-responsive">
              <table class="product-performance-table">
                <thead>
                  <tr>
                    <th>Product Name</th>
                    <th>Category</th>
                    <th>Units Sold</th>
                    <th>Revenue</th>
                    <th>Stock Level</th>
                    <th>Performance</th>
                  </tr>
                </thead>
                <tbody id="product-performance-body">
                  <!-- Product performance data will be loaded here -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Comparison Cards -->
    <div class="row mt-4">
      <div class="col-md-4">
        <div class="comparison-card">
          <h6>Revenue vs Previous Period</h6>
          <div class="comparison-value comparison-positive" id="revenue-comparison">+0%</div>
          <p class="text-muted mb-0">Compared to last period</p>
        </div>
      </div>
      <div class="col-md-4">
        <div class="comparison-card">
          <h6>Orders vs Previous Period</h6>
          <div class="comparison-value comparison-positive" id="orders-comparison">+0%</div>
          <p class="text-muted mb-0">Compared to last period</p>
        </div>
      </div>
      <div class="col-md-4">
        <div class="comparison-card">
          <h6>Customer Growth</h6>
          <div class="comparison-value comparison-positive" id="customer-comparison">+0%</div>
          <p class="text-muted mb-0">New customers this period</p>
        </div>
      </div>
    </div>
  </main>

  <!-- Vendor JS Files -->
  <script src="../assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  

  
  <!-- Analytics JS -->
  <script src="../assets/js/owner.js"></script>
  <script>
    // Analytics Manager Class - FINAL VERSION (No logout button)
    class AnalyticsManager {
      constructor() {
        this.currentFarm = null;
        this.currentPeriod = 'month';
        this.charts = {};
        this.cachedProducts = [];
        this.cachedOrders = [];
        this.init();
      }

      async init() {
        this.currentFarm = this.getCurrentFarm();
        if (!this.currentFarm) {
          console.error('No farm data found');
          this.showErrorMessage('Please login to access analytics');
          return;
        }

        // Pre-load data before analytics
        await this.preloadFarmData();
        this.setupEventListeners();
        this.initializeCharts();
        this.loadAnalyticsData();
      }

      getCurrentFarm() {
        const ownerData = localStorage.getItem('farmOwnerData');
        if (!ownerData) return null;
        
        const parsedData = JSON.parse(ownerData);
        if (!parsedData.isLoggedIn) return null;
        
        return parsedData;
      }

      async preloadFarmData() {
        try {
          console.log('Preloading farm data...');
          this.cachedProducts = await this.getFarmProducts();
          this.cachedOrders = await this.getFarmOrders();
          console.log('Preloaded data - Products:', this.cachedProducts.length, 'Orders:', this.cachedOrders.length);
        } catch (error) {
          console.error('Error preloading farm data:', error);
          this.cachedProducts = [];
          this.cachedOrders = [];
        }
      }

      setupEventListeners() {
        // Period filter buttons
        const periodButtons = document.querySelectorAll('[data-period]');
        periodButtons.forEach(button => {
          button.addEventListener('click', (e) => {
            periodButtons.forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');
            
            this.currentPeriod = e.target.getAttribute('data-period');
            this.loadAnalyticsData();
          });
        });
      }

      async forceRefresh() {
        console.log('Force refreshing analytics...');
        await this.preloadFarmData();
        this.loadAnalyticsData();
      }

      async loadAnalyticsData() {
        try {
          this.showLoadingState();

          // Ensure data is loaded
          if (this.cachedProducts.length === 0 || this.cachedOrders.length === 0) {
            await this.preloadFarmData();
          }

          // Calculate analytics data
          const analyticsData = this.calculateAnalytics(this.cachedOrders, this.cachedProducts);
          
          // Update UI with analytics data
          this.updateAnalyticsUI(analyticsData);
          
          // Update charts
          this.updateCharts(analyticsData);
          
        } catch (error) {
          console.error('Error loading analytics data:', error);
          this.showErrorMessage('Error loading analytics data. Please try refreshing.');
        } finally {
          this.hideLoadingState();
        }
      }

      async getFarmOrders() {
        try {
          const allOrders = JSON.parse(localStorage.getItem('orders')) || [];
          console.log('All orders from storage:', allOrders.length);
          
          // Filter orders that contain this farm's products
          const farmOrders = allOrders.filter(order => {
            return order.items.some(item => {
              return this.isFarmProduct(item);
            });
          });
          
          console.log('Filtered farm orders:', farmOrders.length);
          return farmOrders;
        } catch (error) {
          console.error('Error getting farm orders:', error);
          return [];
        }
      }

      isFarmProduct(item) {
        if (!this.currentFarm) return false;
        
        return (
          item.farmId === this.currentFarm.id ||
          item.farmName === this.currentFarm.farm?.name ||
          this.cachedProducts.some(product => product.id === item.id)
        );
      }

      async getFarmProducts() {
        try {
          let farmProducts = [];
          
          // Get from owner products (pending/approved)
          const ownerProducts = JSON.parse(localStorage.getItem('ownerProducts')) || [];
          const farmOwnerProducts = ownerProducts.filter(product => 
            product.farmId === this.currentFarm.id
          );
          console.log('Owner products:', farmOwnerProducts.length);
          
          // Get from IndexedDB (approved products)
          let dbProducts = [];
          try {
            dbProducts = await this.getProductsFromIndexedDB();
            console.log('DB products:', dbProducts.length);
          } catch (error) {
            console.error('Error getting products from IndexedDB:', error);
          }
          
          // Get from products in localStorage (fallback)
          const allProducts = JSON.parse(localStorage.getItem('products')) || [];
          const localStorageProducts = allProducts.filter(product => 
            product.farmId === this.currentFarm.id
          );
          console.log('LocalStorage products:', localStorageProducts.length);
          
          // Combine all products and remove duplicates
          const allFarmProducts = [...farmOwnerProducts, ...dbProducts, ...localStorageProducts];
          farmProducts = allFarmProducts.filter((product, index, self) =>
            index === self.findIndex(p => p.id === product.id)
          );
          
          console.log('Combined farm products:', farmProducts.length);
          return farmProducts;
        } catch (error) {
          console.error('Error getting farm products:', error);
          return [];
        }
      }

      getProductsFromIndexedDB() {
        return new Promise((resolve, reject) => {
          const request = indexedDB.open('FarmMarketDB', 4);
          
          request.onerror = () => {
            console.error('Error opening IndexedDB');
            resolve([]);
          };
          
          request.onsuccess = () => {
            const db = request.result;
            if (!db.objectStoreNames.contains('products')) {
              resolve([]);
              return;
            }
            
            const transaction = db.transaction(['products'], 'readonly');
            const store = transaction.objectStore('products');
            
            // Try to use farmId index if it exists
            if (store.indexNames.contains('farmId')) {
              const index = store.index('farmId');
              const getRequest = index.getAll(this.currentFarm.id);
              
              getRequest.onerror = () => {
                console.error('Error getting products by farmId');
                resolve([]);
              };
              
              getRequest.onsuccess = () => {
                resolve(getRequest.result || []);
              };
            } else {
              // Fallback: get all products and filter
              const getAllRequest = store.getAll();
              
              getAllRequest.onerror = () => {
                console.error('Error getting all products');
                resolve([]);
              };
              
              getAllRequest.onsuccess = () => {
                const products = getAllRequest.result.filter(product => 
                  product.farmId === this.currentFarm.id
                );
                resolve(products);
              };
            }
          };
        });
      }

      calculateAnalytics(orders, products) {
        // Filter orders by current period
        const periodOrders = this.filterOrdersByPeriod(orders, this.currentPeriod);
        
        console.log('Analytics Calculation:');
        console.log('- Total orders:', orders.length);
        console.log('- Period orders:', periodOrders.length);
        console.log('- Products:', products.length);

        // Calculate basic metrics
        const revenueData = this.calculateRevenueData(periodOrders, products);
        const totalRevenue = revenueData.totalRevenue;
        const totalOrders = periodOrders.length;
        const avgOrderValue = totalOrders > 0 ? totalRevenue / totalOrders : 0;
        
        // Calculate customer count
        const customerCount = this.calculateCustomerCount(periodOrders);
        
        // Calculate net earnings (after 15% commission)
        const netEarnings = totalRevenue * 0.85;
        
        // Calculate category sales
        const categorySales = this.calculateCategorySales(periodOrders, products);
        
        // Calculate order status distribution
        const orderStatus = this.calculateOrderStatus(periodOrders);
        
        // Calculate monthly performance
        const monthlyData = this.calculateMonthlyPerformance(orders, products);
        
        // Calculate product performance
        const productPerformance = this.calculateProductPerformance(revenueData.productItems);
        
        // Calculate comparison with previous period
        const comparisonData = this.calculatePeriodComparison(orders, products);
        
        console.log('Analytics Results:', {
          totalRevenue,
          totalOrders,
          avgOrderValue,
          customerCount,
          netEarnings,
          productPerformanceCount: productPerformance.length
        });

        return {
          totalRevenue,
          totalOrders,
          avgOrderValue,
          customerCount,
          netEarnings,
          categorySales,
          orderStatus,
          monthlyData,
          productPerformance,
          comparisonData
        };
      }

      calculateRevenueData(orders, products) {
        let totalRevenue = 0;
        const productItems = [];

        orders.forEach(order => {
          let orderRevenue = 0;
          const orderProductItems = [];

          order.items.forEach(item => {
            // Check if this item belongs to current farm
            if (this.isFarmProduct(item)) {
              const itemRevenue = item.price * item.quantity;
              orderRevenue += itemRevenue;
              
              // Track product performance data
              const existingProduct = productItems.find(p => p.id === item.id);
              if (existingProduct) {
                existingProduct.unitsSold += item.quantity;
                existingProduct.revenue += itemRevenue;
              } else {
                const product = products.find(p => p.id === item.id) || {};
                productItems.push({
                  id: item.id,
                  name: item.name || product.name || 'Unknown Product',
                  category: product.category || 'Unknown',
                  unitsSold: item.quantity,
                  revenue: itemRevenue,
                  stock: product.stock || product.quantity || 0,
                  price: item.price
                });
              }

              orderProductItems.push({
                id: item.id,
                name: item.name,
                quantity: item.quantity,
                price: item.price,
                revenue: itemRevenue
              });
            }
          });

          totalRevenue += orderRevenue;

          // Log order details for debugging
          if (orderRevenue > 0) {
            console.log(`Order ${order.id}: $${orderRevenue.toFixed(2)}`, orderProductItems);
          }
        });

        console.log('Total Revenue Calculated:', totalRevenue);
        console.log('Product Items:', productItems);

        return { totalRevenue, productItems };
      }

      calculateCustomerCount(orders) {
        const customers = new Set();
        orders.forEach(order => {
          if (order.delivery?.location?.email) {
            customers.add(order.delivery.location.email);
          } else if (order.customerEmail) {
            customers.add(order.customerEmail);
          } else if (order.userId) {
            customers.add(order.userId);
          }
        });
        return customers.size;
      }

      filterOrdersByPeriod(orders, period) {
        const now = new Date();
        let startDate;
        
        switch(period) {
          case 'week':
            startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            break;
          case 'month':
            startDate = new Date(now.getFullYear(), now.getMonth(), 1);
            break;
          case 'quarter':
            const quarter = Math.floor(now.getMonth() / 3);
            startDate = new Date(now.getFullYear(), quarter * 3, 1);
            break;
          case 'year':
            startDate = new Date(now.getFullYear(), 0, 1);
            break;
          default:
            startDate = new Date(now.getFullYear(), now.getMonth(), 1);
        }
        
        return orders.filter(order => {
          const orderDate = new Date(order.date);
          return orderDate >= startDate && orderDate <= now;
        });
      }

      calculateCategorySales(orders, products) {
        const categoryMap = {};
        
        orders.forEach(order => {
          order.items.forEach(item => {
            if (this.isFarmProduct(item)) {
              const product = products.find(p => p.id === item.id) || {};
              const category = product.category || 'Unknown';
              const itemTotal = item.price * item.quantity;
              
              if (!categoryMap[category]) {
                categoryMap[category] = 0;
              }
              
              categoryMap[category] += itemTotal;
            }
          });
        });

        // If no categories found, provide sample data for demo
        if (Object.keys(categoryMap).length === 0) {
          return {
            'Vegetables': 500,
            'Fruits': 300,
            'Dairy': 200
          };
        }
        
        return categoryMap;
      }

      calculateOrderStatus(orders) {
        const statusCount = {
          pending: 0,
          confirmed: 0,
          processing: 0,
          shipped: 0,
          delivered: 0,
          cancelled: 0
        };
        
        orders.forEach(order => {
          const status = order.status?.toLowerCase() || 'pending';
          if (statusCount[status] !== undefined) {
            statusCount[status]++;
          } else {
            statusCount.pending++; // Default to pending for unknown status
          }
        });
        
        return statusCount;
      }

      calculateMonthlyPerformance(orders, products) {
        const monthlyData = {
          revenue: Array(12).fill(0),
          orders: Array(12).fill(0)
        };
        
        const currentYear = new Date().getFullYear();
        
        orders.forEach(order => {
          const orderDate = new Date(order.date);
          if (orderDate.getFullYear() === currentYear) {
            const month = orderDate.getMonth();
            
            // Count order
            monthlyData.orders[month]++;
            
            // Calculate revenue for this farm's products
            let orderRevenue = 0;
            order.items.forEach(item => {
              if (this.isFarmProduct(item)) {
                orderRevenue += item.price * item.quantity;
              }
            });
            
            monthlyData.revenue[month] += orderRevenue;
          }
        });
        
        return monthlyData;
      }

      calculateProductPerformance(productItems) {
        const performanceData = productItems.map(product => {
          // Simple performance rating based on revenue
          let performance = 'Low';
          if (product.revenue > 500) performance = 'High';
          else if (product.revenue > 100) performance = 'Medium';
          
          return {
            ...product,
            performance
          };
        }).sort((a, b) => b.revenue - a.revenue);

        console.log('Product Performance Data:', performanceData);
        return performanceData;
      }

      calculatePeriodComparison(orders, products) {
        // Calculate actual comparison with previous period
        const currentPeriodOrders = this.filterOrdersByPeriod(orders, this.currentPeriod);
        const previousPeriodOrders = this.getPreviousPeriodOrders(orders, this.currentPeriod);
        
        const currentRevenue = this.calculateRevenueData(currentPeriodOrders, products).totalRevenue;
        const previousRevenue = this.calculateRevenueData(previousPeriodOrders, products).totalRevenue;
        
        const revenueGrowth = previousRevenue > 0 ? ((currentRevenue - previousRevenue) / previousRevenue) * 100 : 100;
        
        const ordersGrowth = previousPeriodOrders.length > 0 ? 
          ((currentPeriodOrders.length - previousPeriodOrders.length) / previousPeriodOrders.length) * 100 : 100;
        
        const currentCustomers = this.calculateCustomerCount(currentPeriodOrders);
        const previousCustomers = this.calculateCustomerCount(previousPeriodOrders);
        const customersGrowth = previousCustomers > 0 ? 
          ((currentCustomers - previousCustomers) / previousCustomers) * 100 : 100;

        return {
          revenue: Math.max(0, revenueGrowth),
          orders: Math.max(0, ordersGrowth),
          customers: Math.max(0, customersGrowth)
        };
      }

      getPreviousPeriodOrders(orders, currentPeriod) {
        const now = new Date();
        let startDate, endDate;
        
        switch(currentPeriod) {
          case 'week':
            endDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            startDate = new Date(endDate.getTime() - 7 * 24 * 60 * 60 * 1000);
            break;
          case 'month':
            startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            endDate = new Date(now.getFullYear(), now.getMonth(), 0);
            break;
          case 'quarter':
            const currentQuarter = Math.floor(now.getMonth() / 3);
            const previousQuarter = currentQuarter === 0 ? 3 : currentQuarter - 1;
            const year = currentQuarter === 0 ? now.getFullYear() - 1 : now.getFullYear();
            startDate = new Date(year, previousQuarter * 3, 1);
            endDate = new Date(year, previousQuarter * 3 + 3, 0);
            break;
          case 'year':
            startDate = new Date(now.getFullYear() - 1, 0, 1);
            endDate = new Date(now.getFullYear() - 1, 11, 31);
            break;
          default:
            startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            endDate = new Date(now.getFullYear(), now.getMonth(), 0);
        }
        
        return orders.filter(order => {
          const orderDate = new Date(order.date);
          return orderDate >= startDate && orderDate <= endDate;
        });
      }

      updateAnalyticsUI(data) {
        console.log('Updating UI with data:', data);
        
        // Update key metrics
        this.safeUpdateElement('total-revenue', `$${(data.totalRevenue || 0).toFixed(2)}`);
        this.safeUpdateElement('total-orders', data.totalOrders || 0);
        this.safeUpdateElement('avg-order-value', `$${(data.avgOrderValue || 0).toFixed(2)}`);
        this.safeUpdateElement('customer-count', data.customerCount || 0);
        this.safeUpdateElement('net-earnings', `$${(data.netEarnings || 0).toFixed(2)}`);
        
        // Update trends
        this.safeUpdateElement('revenue-trend', `+${(data.comparisonData?.revenue || 0).toFixed(1)}%`);
        this.safeUpdateElement('orders-trend', `+${(data.comparisonData?.orders || 0).toFixed(1)}%`);
        this.safeUpdateElement('aov-trend', '+5.2%'); // Static for demo
        this.safeUpdateElement('customer-trend', `+${(data.comparisonData?.customers || 0).toFixed(1)}%`);
        this.safeUpdateElement('earnings-trend', `+${(data.comparisonData?.revenue || 0).toFixed(1)}%`);
        
        // Update comparison cards
        this.safeUpdateElement('revenue-comparison', `+${(data.comparisonData?.revenue || 0).toFixed(1)}%`);
        this.safeUpdateElement('orders-comparison', `+${(data.comparisonData?.orders || 0).toFixed(1)}%`);
        this.safeUpdateElement('customer-comparison', `+${(data.comparisonData?.customers || 0).toFixed(1)}%`);
        
        // Update product performance table
        this.updateProductPerformanceTable(data.productPerformance || []);
      }

      safeUpdateElement(id, value) {
        const element = document.getElementById(id);
        if (element) {
          element.textContent = value;
        } else {
          console.warn(`Element with id '${id}' not found`);
        }
      }

      updateProductPerformanceTable(products) {
        const tbody = document.getElementById('product-performance-body');
        if (!tbody) {
          console.warn('Product performance table body not found');
          return;
        }
        
        if (products.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="6" class="text-center py-4">
                <i class="bi bi-inbox display-4 d-block text-muted mb-2"></i>
                <p class="text-muted">No product performance data available</p>
                <small class="text-muted">Sales data will appear here when customers purchase your products</small>
              </td>
            </tr>
          `;
          return;
        }
        
        tbody.innerHTML = products.map(product => `
          <tr>
            <td>${this.escapeHtml(product.name)}</td>
            <td>${this.formatCategory(product.category)}</td>
            <td>${product.unitsSold}</td>
            <td>$${product.revenue.toFixed(2)}</td>
            <td>
              <span class="badge ${product.stock > 10 ? 'bg-success' : product.stock > 0 ? 'bg-warning' : 'bg-danger'}">
                ${product.stock} in stock
              </span>
            </td>
            <td>
              <span class="performance-badge performance-${product.performance.toLowerCase()}">
                ${product.performance}
              </span>
            </td>
          </tr>
        `).join('');
      }

      escapeHtml(text) {
        if (!text) return 'Unknown Product';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      initializeCharts() {
        // Revenue Trend Chart (Line Chart)
        const revenueCtx = document.getElementById('revenueChart');
        if (revenueCtx) {
          this.charts.revenue = new Chart(revenueCtx.getContext('2d'), {
            type: 'line',
            data: {
              labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
              datasets: [
                {
                  label: 'Revenue',
                  data: [0, 0, 0, 0],
                  borderColor: '#2c5530',
                  backgroundColor: 'rgba(44, 85, 48, 0.1)',
                  tension: 0.4,
                  fill: true
                },
                {
                  label: 'Previous Period',
                  data: [0, 0, 0, 0],
                  borderColor: '#6c757d',
                  backgroundColor: 'transparent',
                  borderDash: [5, 5],
                  tension: 0.4
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: false
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  grid: {
                    color: 'rgba(0, 0, 0, 0.1)'
                  },
                  ticks: {
                    callback: function(value) {
                      return '$' + value;
                    }
                  }
                },
                x: {
                  grid: {
                    display: false
                  }
                }
              }
            }
          });
        }
        
        // Category Sales Chart (Doughnut)
        const categoryCtx = document.getElementById('categoryChart');
        if (categoryCtx) {
          this.charts.category = new Chart(categoryCtx.getContext('2d'), {
            type: 'doughnut',
            data: {
              labels: [],
              datasets: [{
                data: [],
                backgroundColor: [
                  '#2c5530',
                  '#4a7c59',
                  '#6ba083',
                  '#8dc3a7',
                  '#a8d5ba',
                  '#c4e7d4'
                ],
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: 'bottom'
                }
              }
            }
          });
        }
        
        // Order Status Chart (Pie)
        const orderStatusCtx = document.getElementById('orderStatusChart');
        if (orderStatusCtx) {
          this.charts.orderStatus = new Chart(orderStatusCtx.getContext('2d'), {
            type: 'pie',
            data: {
              labels: [],
              datasets: [{
                data: [],
                backgroundColor: [
                  '#ffc107',
                  '#17a2b8',
                  '#6f42c1',
                  '#28a745',
                  '#dc3545'
                ],
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: 'bottom'
                }
              }
            }
          });
        }
        
        // Monthly Performance Chart (Bar)
        const monthlyCtx = document.getElementById('monthlyChart');
        if (monthlyCtx) {
          this.charts.monthly = new Chart(monthlyCtx.getContext('2d'), {
            type: 'bar',
            data: {
              labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
              datasets: [
                {
                  label: 'Revenue',
                  data: [],
                  backgroundColor: '#2c5530',
                  order: 2
                },
                {
                  label: 'Orders',
                  data: [],
                  backgroundColor: '#fd7e14',
                  type: 'line',
                  order: 1,
                  tension: 0.4
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                y: {
                  beginAtZero: true,
                  grid: {
                    color: 'rgba(0, 0, 0, 0.1)'
                  }
                },
                x: {
                  grid: {
                    display: false
                  }
                }
              }
            }
          });
        }
      }

      updateCharts(data) {
        // Update Revenue Chart
        if (this.charts.revenue) {
          // Generate realistic data based on actual revenue
          const baseValue = data.totalRevenue / 4;
          const currentData = [
            baseValue * 0.8,
            baseValue * 1.2,
            baseValue * 0.9,
            baseValue * 1.1
          ];
          const previousData = currentData.map(value => value * 0.7); // 70% of current
          
          this.charts.revenue.data.datasets[0].data = currentData;
          this.charts.revenue.data.datasets[1].data = previousData;
          this.charts.revenue.update();
        }
        
        // Update Category Chart
        if (this.charts.category && data.categorySales) {
          const categories = Object.keys(data.categorySales);
          const sales = Object.values(data.categorySales);
          
          this.charts.category.data.labels = categories.map(cat => this.formatCategory(cat));
          this.charts.category.data.datasets[0].data = sales;
          this.charts.category.update();
        }
        
        // Update Order Status Chart
        if (this.charts.orderStatus && data.orderStatus) {
          const statuses = Object.keys(data.orderStatus);
          const counts = Object.values(data.orderStatus);
          
          this.charts.orderStatus.data.labels = statuses.map(status => this.formatStatus(status));
          this.charts.orderStatus.data.datasets[0].data = counts;
          this.charts.orderStatus.update();
        }
        
        // Update Monthly Chart
        if (this.charts.monthly && data.monthlyData) {
          this.charts.monthly.data.datasets[0].data = data.monthlyData.revenue;
          this.charts.monthly.data.datasets[1].data = data.monthlyData.orders;
          this.charts.monthly.update();
        }
      }

      showLoadingState() {
        // Add loading indicators to key sections
        const loadingElements = [
          'total-revenue', 'total-orders', 'avg-order-value', 
          'customer-count', 'net-earnings', 'product-performance-body'
        ];
        
        loadingElements.forEach(id => {
          const element = document.getElementById(id);
          if (element) {
            element.innerHTML = `<div class="spinner-border spinner-border-sm" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>`;
          }
        });
      }

      hideLoadingState() {
        // Loading state is removed when actual data is rendered
      }

      showErrorMessage(message) {
        // Create error message display
        const errorDiv = document.createElement('div');
        errorDiv.className = 'alert alert-danger alert-dismissible fade show';
        errorDiv.innerHTML = `
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        const main = document.querySelector('.owner-main');
        if (main) {
          main.insertBefore(errorDiv, main.firstChild);
        }
      }

      formatCategory(category) {
        if (!category) return 'Uncategorized';
        return category.charAt(0).toUpperCase() + category.slice(1);
      }

      formatStatus(status) {
        if (!status) return 'Unknown';
        return status.charAt(0).toUpperCase() + status.slice(1);
      }
    }

    // Initialize analytics when page loads
    document.addEventListener('DOMContentLoaded', function() {
      window.analyticsManager = new AnalyticsManager();
    });
  </script>
</body>
</html>